From b30789f67a207b5434f7a5514d6e3b2328b3352e Mon Sep 17 00:00:00 2001
From: Sammy He <r62914@freescale.com>
Date: Sun, 26 Apr 2009 17:56:03 +0800
Subject: [PATCH 052/280] ENGR00111849 Upgrade vpu firmware to V1.1.5 on MX51

Upgrade vpu firmware to V1.1.5 on MX51

Signed-off-by: Sammy He <r62914@freescale.com>
---
 vpu/vpu_fw/vpu_fw_imx51.bin | Bin 139280 -> 139280 bytes
 vpu/vpu_lib.c               |  16 ++++++++++------
 vpu/vpu_lib.h               |   4 +++-
 vpu/vpu_reg.h               |   1 +
 4 files changed, 14 insertions(+), 7 deletions(-)

diff --git a/vpu/vpu_fw/vpu_fw_imx51.bin b/vpu/vpu_fw/vpu_fw_imx51.bin
index 90a6bc6783c1276ffbf0c008cb8df2fe60a03770..022ecd80eecf569ae00bc8e05386c6802358195e 100644
GIT binary patch
delta 4451
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

delta 4377
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
LLWhI}zCrvK?A)Zh

diff --git a/vpu/vpu_lib.c b/vpu/vpu_lib.c
index 7dc6198..b96915a 100644
--- a/vpu/vpu_lib.c
+++ b/vpu/vpu_lib.c
@@ -198,7 +198,10 @@ RetCode vpu_Init(void *cb)
 			ResetVpu();
 		}
 
+		VpuWriteReg(BIT_BUSY_FLAG, 1);
 		VpuWriteReg(BIT_CODE_RUN, 1);
+		while (VpuReadReg(BIT_BUSY_FLAG));
+
 		IOClkGateSet(false);
 
 		free(bit_code);
@@ -1923,6 +1926,10 @@ RetCode vpu_DecGetInitialInfo(DecHandle handle, DecInitialInfo * info)
 
 	VpuWriteReg(CMD_DEC_SEQ_OPTION, val);
 
+	if( pCodecInst->codecMode == MP4_DEC ) {
+		VpuWriteReg(CMD_DEC_SEQ_MP4_ASP_CLASS, pDecInfo->openParam.mp4Class);
+	}
+
 	if (pCodecInst->codecMode == AVC_DEC) {
 		VpuWriteReg(CMD_DEC_SEQ_PS_BB_START,
 			    pDecInfo->openParam.psSaveBuffer);
@@ -2667,12 +2674,9 @@ RetCode vpu_DecGetOutputInfo(DecHandle handle, DecOutputInfo * info)
 		info->mp4PackedPBframe = ((val >> 16) & 0x01);
 	}
 
-	if (pCodecInst->codecMode != RV_DEC
-	    && pCodecInst->codecMode != MJPG_DEC) {
-		val = VpuReadReg(RET_DEC_PIC_SIZE);     /* decoding picture size */
-		info->decPicHeight = val & 0xFFFF;
-		info->decPicWidth = (val >> 16) & 0xFFFF;
-	}
+	val = VpuReadReg(RET_DEC_PIC_SIZE);     /* decoding picture size */
+	info->decPicHeight = val & 0xFFFF;
+	info->decPicWidth = (val >> 16) & 0xFFFF;
 
 	if (cpu_is_mx51() && pCodecInst->codecMode == AVC_DEC) {
 		val = VpuReadReg(RET_DEC_PIC_CROP_LEFT_RIGHT);  /* frame crop information(left, right) */
diff --git a/vpu/vpu_lib.h b/vpu/vpu_lib.h
index 6372718..a109faa 100644
--- a/vpu/vpu_lib.h
+++ b/vpu/vpu_lib.h
@@ -166,6 +166,7 @@ typedef struct {
 	int mjpg_thumbNailDecEnable;
 	PhysicalAddress psSaveBuffer;
 	int psSaveBufferSize;
+	int mp4Class;
 } DecOpenParam;
 
 typedef struct {
@@ -467,6 +468,7 @@ typedef struct vpu_versioninfo {
 
 /*
  * Revision History:
+ * v4.5.5 [2009.04.28] upgrade mx51 fw to v1.1.5
  * v4.5.4 [2009.03.19] upgrade mx37 fw to v1.1.0
  * v4.4.4 [2009.02.27] support data report and change VPU APIs
  * v4.4.3 [2009.01.19] support chromaInterleave of encoder on MX51
@@ -475,7 +477,7 @@ typedef struct vpu_versioninfo {
  * v4.1.2 [2008.08.22] update MX37 VPU firmware to V1.0.5
  * v4.0.2 [2008.08.21] add the IOClkGateSet() for power saving.
  */
-#define VPU_LIB_VERSION_CODE	VPU_LIB_VERSION(4, 5, 4)
+#define VPU_LIB_VERSION_CODE	VPU_LIB_VERSION(4, 5, 5)
 
 extern unsigned int system_rev;
 
diff --git a/vpu/vpu_reg.h b/vpu/vpu_reg.h
index dd199bb..0b01e45 100644
--- a/vpu/vpu_reg.h
+++ b/vpu/vpu_reg.h
@@ -113,6 +113,7 @@
 #define CMD_DEC_SEQ_PS_BB_START     	0x194
 #define CMD_DEC_SEQ_PS_BB_SIZE      	0x198
 #define CMD_DEC_SEQ_JPG_THUMB_EN        0x19C
+#define CMD_DEC_SEQ_MP4_ASP_CLASS	0x19C
 
 #define CMD_DEC_SEQ_INIT_ESCAPE		0x114
 
-- 
1.8.0

